name: Build and Release

on:
  push:
    tags:
      - "v*" # å½“æ¨é€ v å¼€å¤´çš„ tag æ—¶è§¦å‘

# æˆäºˆ GITHUB_TOKEN å†™æƒé™ï¼Œç”¨äºåˆ›å»º Release
permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. å®‰è£… Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      # 3. æ„å»ºå‰ç«¯
      - name: Build Frontend
        run: |
          cd frontend
          npm ci
          npm run build

      # 4. åˆ›å»ºå‘å¸ƒåŒ…
      - name: Create Release Archive
        run: |
          VERSION=${{ github.ref_name }}

          # åˆ›å»ºå¹²å‡€çš„å‘å¸ƒç›®å½•
          mkdir -p release-build

          # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
          cp app.py generate_cert.py release-build/
          cp install.sh install.bat run.sh run.bat build.sh build.bat release-build/
          cp README.md README.en.md LICENSE release-build/ 2>/dev/null || true

          # å¤åˆ¶ç›®å½•
          cp -r templates static release-build/
          cp -r frontend release-build/

          # æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
          rm -rf release-build/frontend/node_modules
          rm -rf release-build/frontend/.vite
          rm -rf release-build/frontend/src  # æ™®é€šç”¨æˆ·ä¸éœ€è¦æºç 

          # åˆ›å»º zip
          cd release-build
          zip -r ../sharp-gui-${VERSION}.zip .

          echo "Created: sharp-gui-${VERSION}.zip"
          ls -lh ../sharp-gui-${VERSION}.zip

      # 5. ä¸Šä¼ åˆ° Release
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: sharp-gui-*.zip
          generate_release_notes: true
          body: |
            ## ğŸ“¦ å¿«é€Ÿä½¿ç”¨ (Quick Start)

            1. ä¸‹è½½ `sharp-gui-${{ github.ref_name }}.zip`
            2. è§£å‹åè¿è¡Œå®‰è£…è„šæœ¬:
               - **Linux/macOS**: `./install.sh && ./run.sh`
               - **Windows**: `install.bat` ç„¶å `run.bat`
            3. æµè§ˆå™¨è®¿é—® `https://127.0.0.1:5050`

            ğŸ“– **è¯¦ç»†æ•™ç¨‹ (ä¸­æ–‡)**: [æŸ¥çœ‹ README](https://github.com/${{ github.repository }})

            ğŸ“– **English Guide**: [View README](https://github.com/${{ github.repository }}/blob/main/README.en.md)

            ---
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
