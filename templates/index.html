<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sharp 3D Gallery</title>
    <link rel="icon" href="data:," />
    <style>
      /* --- å¯åŠ¨åŠ è½½/è¯Šæ–­å±å¹• (ç¾åŒ–ç‰ˆ) --- */
      #boot-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: opacity 0.5s ease;
      }

      .boot-content {
        text-align: center;
        background: rgba(255, 255, 255, 0.5);
        padding: 40px;
        border-radius: 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.8);
        max-width: 80%;
        width: 300px;
      }

      .boot-spinner {
        width: 40px;
        height: 40px;
        margin: 0 auto 20px;
        border: 3px solid rgba(0, 113, 227, 0.1);
        border-radius: 50%;
        border-top-color: #0071e3;
        animation: spin 1s ease-in-out infinite;
      }

      #boot-status {
        font-size: 16px;
        font-weight: 500;
        color: #333;
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display",
          sans-serif;
      }

      #boot-details-btn {
        margin-top: 16px;
        font-size: 12px;
        color: #0071e3;
        background: none;
        border: none;
        cursor: pointer;
        text-decoration: underline;
        display: none;
        /* é»˜è®¤éšè—ï¼Œå‡ºé”™æ—¶æ˜¾ç¤º */
      }

      #boot-log {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 50%;
        background: #1d1d1f;
        color: #00ff00;
        font-family: monospace;
        font-size: 12px;
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
        display: none;
        z-index: 10000;
        border-top: 1px solid #333;
      }

      .boot-error {
        color: #ff3b30;
      }

      .boot-success {
        color: #34c759;
      }

      :root {
        /* åŸºç¡€è‰²è°ƒ */
        --bg-color: #f5f5f7;
        --text-primary: #1d1d1f;
        --accent-blue: #0071e3;

        /* âœ¨ é«˜çº§æ¯›ç»ç’ƒç³»ç»Ÿ */
        --glass-bg: rgba(255, 255, 255, 0.65);
        --glass-border: rgba(255, 255, 255, 0.6);
        --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        --glass-blur: blur(30px) saturate(180%);

        --sidebar-width: 280px;
      }

      body {
        margin: 0;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display",
          sans-serif;
        background-color: var(--bg-color);
        color: var(--text-primary);
        display: flex;
        height: 100vh;
      }

      /* --- å·¦ä¾§è¾¹æ  (Gallery) --- */
      #sidebar {
        width: var(--sidebar-width);
        height: 100%;
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-right: 1px solid rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        z-index: 20;
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      }

      .app-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* æ–°å»ºæŒ‰é’® */
      #btn-new {
        width: 100%;
        background: var(--accent-blue);
        color: white;
        border: none;
        padding: 10px;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.2s;
        box-shadow: 0 4px 10px rgba(0, 113, 227, 0.2);
      }

      #btn-new:hover {
        background: #0077ed;
        transform: translateY(-1px);
      }

      #btn-new:disabled {
        opacity: 0.6;
        cursor: wait;
      }

      /* é˜Ÿåˆ—åŒºåŸŸ */
      #queue-container {
        padding: 12px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        display: none;
        /* æœ‰ä»»åŠ¡æ—¶æ˜¾ç¤º */
        background: rgba(255, 255, 255, 0.3);
        max-height: 180px;
        overflow-y: auto;
      }

      .section-title {
        font-size: 11px;
        color: #888;
        font-weight: 600;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        text-transform: uppercase;
      }

      .queue-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.5);
        margin-bottom: 6px;
        font-size: 12px;
      }

      .queue-status-icon {
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* æ—‹è½¬åŠ¨ç”» */
      .spin {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        100% {
          transform: rotate(360deg);
        }
      }

      /* æ‹–æ‹½é«˜äº® */
      #sidebar.drag-over {
        background: rgba(0, 113, 227, 0.1) !important;
        box-shadow: inset 0 0 0 2px var(--accent-blue);
      }

      #sidebar.drag-over::after {
        content: "Drop images here to generate";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 14px;
        font-weight: 600;
        color: var(--accent-blue);
        pointer-events: none;
      }

      /* åˆ—è¡¨åŒºåŸŸ */
      #gallery-list {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .gallery-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: transparent;
        position: relative;
        opacity: 1;
        transform: translateX(0);
      }

      /* åˆ é™¤åŠ¨ç”» */
      .gallery-item.deleting {
        opacity: 0;
        transform: translateX(-20px);
        pointer-events: none;
      }

      .gallery-item:hover {
        background: rgba(255, 255, 255, 0.6);
      }

      .gallery-item.active {
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .thumb {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        object-fit: cover;
        background: linear-gradient(
          90deg,
          #f0f0f0 25%,
          #e0e0e0 50%,
          #f0f0f0 75%
        );
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s infinite;
      }

      .thumb[src]:not([src=""]) {
        animation: none;
        background: #eee;
      }

      @keyframes skeleton-loading {
        0% {
          background-position: 200% 0;
        }

        100% {
          background-position: -200% 0;
        }
      }

      .item-info {
        flex: 1;
        overflow: hidden;
        max-width: calc(100% - 100px);
        /* ä¸ºæŒ‰é’®ç•™å‡ºç©ºé—´ */
      }

      .item-name {
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .item-date {
        font-size: 11px;
        color: #888;
      }

      /* åˆ é™¤æŒ‰é’® */
      .btn-delete {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.1);
        color: #666;
        border: none;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        transition: all 0.2s;
      }

      .gallery-item:hover .btn-delete {
        display: flex;
      }

      .btn-delete:hover {
        background: #fff;
        color: #666;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
      }

      /* ä¸‹è½½æŒ‰é’® */
      .btn-download {
        position: absolute;
        right: 36px;
        top: 50%;
        transform: translateY(-50%);
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.1);
        color: #666;
        border: none;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        line-height: 1;
        transition: all 0.2s;
      }

      .gallery-item:hover .btn-download {
        display: flex;
      }

      .btn-download:hover {
        background: #fff;
        color: #666;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
      }

      /* æŸ¥çœ‹åŸå›¾æŒ‰é’® */
      .btn-preview {
        position: absolute;
        right: 64px;
        top: 50%;
        transform: translateY(-50%);
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.1);
        color: #666;
        border: none;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        transition: all 0.2s;
      }

      .gallery-item:hover .btn-preview {
        display: flex;
      }

      .btn-preview:hover {
        background: #fff;
        color: #666;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
      }

      /* ç»Ÿä¸€æŒ‰é’®å›¾æ ‡å¤§å° */
      .btn-delete svg,
      .btn-download svg,
      .btn-preview svg {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
      }

      /* è§¦å±è®¾å¤‡: å§‹ç»ˆæ˜¾ç¤ºæ“ä½œæŒ‰é’® */
      @media (hover: none) {
        .gallery-item .btn-delete,
        .gallery-item .btn-download,
        .gallery-item .btn-preview {
          display: flex;
          background: #fff;
          color: #666;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        }

        .gallery-item .btn-delete svg,
        .gallery-item .btn-download svg,
        .gallery-item .btn-preview svg {
          width: 14px;
          height: 14px;
        }

        .item-info {
          max-width: calc(100% - 110px);
        }
      }

      /* è®¾ç½®æŒ‰é’® */
      .settings-btn {
        width: 28px;
        height: 28px;
        background: rgba(0, 0, 0, 0.05);
        border: none;
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        margin-left: auto;
      }

      .settings-btn:hover {
        background: rgba(0, 0, 0, 0.1);
      }

      .settings-btn svg {
        width: 16px;
        height: 16px;
        color: #666;
      }

      /* è®¾ç½®å¼¹çª— */
      .settings-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        z-index: 100;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .settings-modal.visible {
        opacity: 1;
      }

      .settings-panel {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-radius: 20px;
        padding: 24px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        transform: scale(0.9);
        transition: transform 0.3s;
      }

      .settings-modal.visible .settings-panel {
        transform: scale(1);
      }

      .settings-panel h3 {
        margin: 0 0 20px 0;
        font-size: 18px;
        font-weight: 600;
      }

      .settings-group {
        margin-bottom: 16px;
      }

      .settings-group label {
        display: block;
        font-size: 12px;
        font-weight: 500;
        color: #666;
        margin-bottom: 6px;
      }

      .settings-group input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        font-size: 13px;
        background: white;
        box-sizing: border-box;
      }

      .settings-group input:focus {
        outline: none;
        border-color: var(--accent-blue);
      }

      .settings-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .settings-actions button {
        flex: 1;
        padding: 10px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .settings-actions .btn-cancel {
        background: rgba(0, 0, 0, 0.05);
        border: none;
        color: #666;
      }

      .settings-actions .btn-save {
        background: var(--accent-blue);
        border: none;
        color: white;
      }

      .settings-actions .btn-save:hover {
        background: #0077ed;
      }

      /* --- å³ä¾§ä¸»åŒºåŸŸ (Viewer) --- */
      #main-content {
        flex: 1;
        position: relative;
        background-image: radial-gradient(
            at 0% 0%,
            rgba(200, 200, 250, 0.3) 0px,
            transparent 50%
          ),
          radial-gradient(
            at 100% 100%,
            rgba(200, 220, 250, 0.3) 0px,
            transparent 50%
          );
      }

      /* ç²’å­èƒŒæ™¯ç”»å¸ƒ */
      #particle-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
        opacity: 1;
        transition: opacity 0.5s ease;
      }

      #particle-canvas.hidden {
        opacity: 0;
      }

      #canvas-container {
        width: 100%;
        height: 100%;
        position: relative;
        z-index: 10;
      }

      /* ç©ºçŠ¶æ€ */
      #empty-state {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #888;
        pointer-events: none;
      }

      .empty-icon {
        width: 64px;
        height: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
        color: var(--accent-blue);
      }

      /* --- è¦†ç›–å±‚ (Loading) --- */
      #loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        z-index: 50;
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        opacity: 0;
        transition: opacity 0.3s;
      }

      #loading-overlay.visible {
        opacity: 1;
      }

      .spinner {
        width: 44px;
        height: 44px;
        border: 4px solid rgba(0, 0, 0, 0.08);
        border-radius: 50%;
        border-top-color: var(--accent-blue);
        animation: spin 0.8s ease-in-out infinite;
        margin-bottom: 16px;
      }

      .loading-text {
        font-size: 15px;
        font-weight: 500;
        color: #555;
      }

      /* è¿›åº¦æ¡ */
      .loading-progress {
        width: 200px;
        height: 4px;
        background: rgba(0, 0, 0, 0.08);
        border-radius: 2px;
        margin-top: 16px;
        overflow: hidden;
      }

      .loading-progress-bar {
        height: 100%;
        background: var(--accent-blue);
        border-radius: 2px;
        width: 0%;
        transition: width 0.3s ease;
      }

      .loading-percent {
        font-size: 12px;
        color: #888;
        margin-top: 8px;
      }

      /* --- åº•éƒ¨æ§åˆ¶æ  --- */
      .controls-container {
        display: none;
        gap: 16px;
        pointer-events: auto;
        transition: opacity 0.3s ease;
      }

      .glass-panel {
        background: var(--glass-bg);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        box-shadow: var(--glass-shadow);
        padding: 8px;
        display: flex;
        gap: 8px;
      }

      button.control-btn {
        background: transparent;
        border: none;
        padding: 12px 20px;
        border-radius: 18px;
        font-size: 14px;
        font-weight: 500;
        color: #444;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* ç¡®ä¿æ‰€æœ‰æ§åˆ¶æŒ‰é’®å›¾æ ‡å¤§å°ä¸€è‡´ */
      button.control-btn svg {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
      }

      button.control-btn:hover {
        background: rgba(255, 255, 255, 0.5);
        color: black;
      }

      button.control-btn.active {
        background: white;
        color: var(--accent-blue);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        font-weight: 600;
      }

      .tooltip {
        position: fixed;
        bottom: 100px;
        left: calc(50% + var(--sidebar-width) / 2);
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        backdrop-filter: blur(10px);
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
        z-index: 100;
      }

      .tooltip.show {
        opacity: 1;
      }

      #file-input {
        display: none;
      }

      /* --- ç§»åŠ¨ç«¯é€‚é… --- */
      #btn-menu {
        display: none;
        /* é»˜è®¤éšè— */
        position: absolute;
        top: 16px;
        left: 16px;
        z-index: 30;
        background: rgba(255, 255, 255, 0.8);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        align-items: center;
        justify-content: center;
        cursor: pointer;
        backdrop-filter: blur(10px);
      }

      #sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        z-index: 15;
        backdrop-filter: blur(2px);
        opacity: 0;
        transition: opacity 0.3s;
      }

      #sidebar-overlay.visible {
        display: block;
        opacity: 1;
      }

      @media (max-width: 768px) {
        body {
          flex-direction: column;
        }

        #sidebar {
          position: absolute;
          left: 0;
          top: 0;
          bottom: 0;
          width: 85%;
          max-width: 320px;
          transform: translateX(-100%);
          transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          background: rgba(255, 255, 255, 0.95);
          box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
        }

        #sidebar.open {
          transform: translateX(0);
        }

        #btn-menu {
          display: flex;
        }

        .controls-container {
          bottom: 30px;
          width: 90%;
          justify-content: center;
        }

        .tooltip {
          left: 50%;
          bottom: 120px;
          width: max-content;
        }

        /* ç§»åŠ¨ç«¯åˆ é™¤æŒ‰é’®ä¼˜åŒ– */
        .btn-delete {
          display: flex !important;
          /* å¼ºåˆ¶æ˜¾ç¤º */
          background: rgba(0, 0, 0, 0.05);
          color: #999;
          width: 28px;
          height: 28px;
        }
      }

      /* --- é™€èºä»ªæ–¹å‘æŒ‡ç¤ºçƒ (iOS 26 é£æ ¼) --- */
      .gyro-indicator {
        position: fixed;
        bottom: 120px;
        right: 24px;
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.5), 0 0 0 1px rgba(0, 0, 0, 0.05);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 60;
        opacity: 0;
        transform: scale(0.8);
        transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
      }

      .gyro-indicator.visible {
        display: flex;
        opacity: 1;
        transform: scale(1);
      }

      .gyro-indicator.active {
        background: rgba(255, 255, 255, 0.35);
        border-color: rgba(255, 255, 255, 0.6);
      }

      .gyro-ball {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.95) 0%,
          rgba(220, 220, 220, 0.9) 100%
        );
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15),
          0 0 12px rgba(255, 255, 255, 0.5),
          inset 0 1px 2px rgba(255, 255, 255, 1);
        position: absolute;
        transition: transform 0.08s ease-out;
        z-index: 2;
      }

      .gyro-crosshair {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      .gyro-crosshair::before,
      .gyro-crosshair::after {
        content: "";
        position: absolute;
        background: rgba(0, 0, 0, 0.08);
      }

      .gyro-crosshair::before {
        width: 1px;
        height: 20px;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
      }

      .gyro-crosshair::after {
        width: 20px;
        height: 1px;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
      }

      /* é™€èºä»ªæç¤ºæ–‡å­— */
      .gyro-hint {
        position: fixed;
        bottom: 190px;
        right: 24px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 6px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        backdrop-filter: blur(10px);
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.3s;
        pointer-events: none;
        z-index: 60;
        white-space: nowrap;
      }

      .gyro-hint.show {
        opacity: 1;
        transform: translateY(0);
      }

      @media (max-width: 768px) {
        .gyro-indicator {
          bottom: 100px;
          right: 16px;
          width: 56px;
          height: 56px;
        }

        .gyro-ball {
          width: 14px;
          height: 14px;
        }

        .gyro-hint {
          bottom: 165px;
          right: 16px;
        }
      }

      /* --- æ§åˆ¶æ æŠ˜å æŒ‰é’® --- */
      .controls-wrapper {
        position: absolute;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 20;
        /* ç¡®ä¿åœ¨ canvas-container (z-index: 10) ä¸Šæ–¹ */
      }

      .controls-wrapper.collapsed {
        transform: translateX(-50%) translateY(calc(100% - 28px));
      }

      .controls-wrapper.collapsed .controls-container {
        opacity: 0;
        pointer-events: none;
      }

      .controls-wrapper.collapsed .collapse-arrow {
        transform: rotate(180deg);
      }

      .collapse-arrow {
        order: -1;
        /* è®©ç®­å¤´æ’åœ¨æœ€å‰é¢ï¼ˆä¸Šæ–¹ï¼‰ */
        width: 36px;
        height: 20px;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .collapse-arrow:hover {
        background: rgba(255, 255, 255, 0.8);
      }

      .collapse-arrow svg {
        width: 14px;
        height: 14px;
        color: #666;
        transition: transform 0.3s ease;
      }

      /* Gyro æŒ‰é’®é»˜è®¤éšè—ï¼ˆPCç«¯ï¼‰ */
      #btn-gyro {
        display: none;
      }

      /* --- æ“ä½œæŒ‡å—æŒ‰é’® --- */
      .help-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 32px;
        height: 32px;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        z-index: 30;
      }

      .help-btn:hover {
        background: rgba(255, 255, 255, 0.85);
        transform: scale(1.05);
      }

      .help-btn svg {
        width: 16px;
        height: 16px;
        color: #555;
      }

      /* --- æ“ä½œæŒ‡å—é¢æ¿ --- */
      .help-panel {
        position: absolute;
        top: 56px;
        right: 16px;
        width: 260px;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.6);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        padding: 16px;
        z-index: 35;
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
        pointer-events: none;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .help-panel.visible {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
      }

      .help-panel h4 {
        margin: 0 0 12px 0;
        font-size: 13px;
        font-weight: 600;
        color: #333;
      }

      .help-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 10px;
        font-size: 12px;
        color: #555;
        line-height: 1.4;
      }

      .help-item:last-child {
        margin-bottom: 0;
      }

      .help-icon {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 6px;
      }

      .help-icon svg {
        width: 12px;
        height: 12px;
        color: #666;
      }

      @media (max-width: 768px) {
        .controls-wrapper {
          bottom: 30px;
          width: 90%;
          max-width: 100%;
        }

        .controls-wrapper.collapsed {
          transform: translateX(-50%) translateY(calc(100% - 28px));
        }

        /* ç§»åŠ¨ç«¯æ˜¾ç¤º Gyro æŒ‰é’® */
        #btn-gyro {
          display: flex;
        }

        /* æ§åˆ¶æ é€‚é…ç§»åŠ¨ç«¯ - å¯æ¨ªå‘æ»šåŠ¨ */
        .glass-panel {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          scrollbar-width: none;
          max-width: calc(100vw - 40px);
        }

        .glass-panel::-webkit-scrollbar {
          display: none;
        }

        /* ç§»åŠ¨ç«¯æŒ‰é’®ç´§å‡‘åŒ– */
        .glass-panel .control-btn {
          padding: 8px 12px;
          font-size: 12px;
          white-space: nowrap;
          flex-shrink: 0;
        }

        .help-panel {
          width: calc(100% - 32px);
          right: 16px;
          left: 16px;
        }
      }

      /* Android å®‰å…¨åŒºåŸŸé€‚é… - é¿å¼€ç³»ç»Ÿæ‰‹åŠ¿æ¡ */
      @supports (padding-bottom: env(safe-area-inset-bottom)) {
        @media (max-width: 768px) {
          .controls-wrapper {
            bottom: calc(30px + env(safe-area-inset-bottom, 20px));
          }
        }
      }
    </style>

    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js",
          "@mkkellogg/gaussian-splats-3d": "https://cdn.jsdelivr.net/npm/@mkkellogg/gaussian-splats-3d@0.4.7/build/gaussian-splats-3d.module.js"
        }
      }
    </script>
  </head>

  <body>
    <!-- å¯åŠ¨å±å¹• (ç¾åŒ–ç‰ˆ) -->
    <div id="boot-screen">
      <div class="boot-content">
        <div class="boot-spinner"></div>
        <h3 id="boot-status">Loading...</h3>
        <button id="boot-details-btn" onclick="toggleBootLog()">
          Show Details
        </button>
      </div>
    </div>
    <div id="boot-log"></div>

    <script>
      // --- å…¨å±€é”™è¯¯æ•è·ä¸æ—¥å¿—ç³»ç»Ÿ ---
      const bootLog = document.getElementById("boot-log");
      const bootStatus = document.getElementById("boot-status");
      const bootScreen = document.getElementById("boot-screen");
      const bootDetailsBtn = document.getElementById("boot-details-btn");
      const bootSpinner = document.querySelector(".boot-spinner");

      function toggleBootLog() {
        bootLog.style.display =
          bootLog.style.display === "block" ? "none" : "block";
      }

      function log(msg, type = "info") {
        const div = document.createElement("div");
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        if (type === "error") div.className = "boot-error";
        if (type === "success") div.className = "boot-success";
        bootLog.appendChild(div);
        bootLog.scrollTop = bootLog.scrollHeight;
        console.log(msg);
      }

      function showErrorState(msg) {
        bootStatus.textContent = "Something went wrong";
        bootStatus.style.color = "#ff3b30";
        bootSpinner.style.borderColor = "#ff3b30";
        bootSpinner.style.animation = "none";
        bootDetailsBtn.style.display = "inline-block";
        log(msg, "error");
      }

      window.onerror = function (msg, url, line, col, error) {
        showErrorState(`Error: ${msg}\nAt: ${url}:${line}:${col}`);
        return false;
      };

      window.addEventListener("unhandledrejection", function (event) {
        showErrorState(`Unhandled Promise Rejection: ${event.reason}`);
      });

      log("Boot sequence started...");
      log("User Agent: " + navigator.userAgent);
    </script>

    <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
    <button id="btn-menu" onclick="toggleSidebar()">
      <svg
        width="24"
        height="24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M4 6h16M4 12h16M4 18h16"
        />
      </svg>
    </button>

    <!-- é®ç½©å±‚ -->
    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- å·¦ä¾§è¾¹æ  -->
    <div id="sidebar">
      <div class="sidebar-header">
        <div class="app-title">
          <svg
            width="20"
            height="20"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
            ></path>
          </svg>
          Sharp 3D
          <button
            class="settings-btn"
            id="btn-settings"
            onclick="openSettings()"
          >
            <svg
              width="16"
              height="16"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
          </button>
        </div>
        <button
          id="btn-new"
          onclick="document.getElementById('file-input').click()"
        >
          <svg
            width="16"
            height="16"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            viewBox="0 0 24 24"
          >
            <path
              d="M12 4v16m8-8H4"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          Generate New
        </button>
        <!-- æ”¯æŒå¤šé€‰ -->
        <input type="file" id="file-input" accept="image/*" multiple />
      </div>

      <!-- é˜Ÿåˆ—åŒºåŸŸ -->
      <div id="queue-container">
        <div class="section-title">Processing Queue</div>
        <div id="queue-list"></div>
      </div>

      <div id="gallery-list">
        <!-- åˆ—è¡¨é¡¹å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
      </div>
    </div>

    <!-- ä¸»æ˜¾ç¤ºåŒº -->
    <div id="main-content">
      <canvas id="particle-canvas"></canvas>
      <div id="canvas-container"></div>

      <!-- ç©ºçŠ¶æ€æç¤º -->
      <div id="empty-state">
        <svg
          class="empty-icon"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
          ></path>
        </svg>
        <div style="font-weight: 500">Select from gallery or generate new</div>
        <div style="font-size: 12px; margin-top: 8px; opacity: 0.7">
          Drop .ply / .splat files here to preview
        </div>
      </div>

      <!-- åŠ è½½é®ç½© -->
      <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">Loading Model...</div>
        <div class="loading-progress">
          <div class="loading-progress-bar" id="loading-progress-bar"></div>
        </div>
        <div class="loading-percent" id="loading-percent">0%</div>
      </div>

      <!-- æ“ä½œæŒ‡å—æŒ‰é’® -->
      <button id="help-btn" class="help-btn" onclick="toggleHelpPanel()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
      </button>

      <!-- æ“ä½œæŒ‡å—é¢æ¿ -->
      <div id="help-panel" class="help-panel">
        <h4>æ“ä½œæŒ‡å—</h4>
        <div class="help-item">
          <div class="help-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"
              />
            </svg>
          </div>
          <div><b>æ‹–æ‹½/è§¦æ‘¸</b> - æ—‹è½¬æ¨¡å‹è§†è§’</div>
        </div>
        <div class="help-item">
          <div class="help-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"
              />
            </svg>
          </div>
          <div><b>æ»šè½®/åŒæŒ‡ç¼©æ”¾</b> - æ”¾å¤§ç¼©å°</div>
        </div>
        <div class="help-item">
          <div class="help-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 18.5A6.5 6.5 0 1112 5.5a6.5 6.5 0 010 13z"
              />
            </svg>
          </div>
          <div><b>Gyro æ¨¡å¼</b> - å¼€å¯åå€¾æ–œæ‰‹æœºé¢„è§ˆ</div>
        </div>
        <div class="help-item">
          <div class="help-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
          </div>
          <div><b>Front View</b> - é™åˆ¶ä¸ºæ­£é¢è§†è§’</div>
        </div>
      </div>

      <!-- åº•éƒ¨æ§åˆ¶æ å®¹å™¨ -->
      <div class="controls-wrapper" id="controls-wrapper">
        <!-- æŠ˜å ç®­å¤´ (åœ¨æ§åˆ¶æ ä¸Šæ–¹) -->
        <div
          class="collapse-arrow"
          id="collapse-arrow"
          onclick="toggleControlsBar()"
        >
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            />
          </svg>
        </div>
        <!-- æ§åˆ¶æ  -->
        <div class="controls-container" id="controls-bar">
          <div class="glass-panel">
            <button
              id="btn-limit"
              class="control-btn active"
              onclick="toggleLimits()"
            >
              <svg
                width="18"
                height="18"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                />
              </svg>
              Front View
            </button>
            <button
              id="btn-gyro"
              class="control-btn"
              onclick="toggleGyroMode()"
            >
              <svg
                width="18"
                height="18"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 18.5A6.5 6.5 0 1112 5.5a6.5 6.5 0 010 13zM12 2v2m0 16v2M2 12h2m16 0h2m-4.93-5.07l1.41-1.41m-12.02 0l1.41 1.41m0 10.14l-1.41 1.41m12.02 0l-1.41-1.41"
                />
              </svg>
              Gyro
            </button>
            <button class="control-btn" onclick="resetCamera()">
              <svg
                width="18"
                height="18"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
              Reset
            </button>
            <button
              id="btn-fullscreen"
              class="control-btn"
              onclick="toggleFullscreen()"
            >
              <svg
                width="18"
                height="18"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"
                />
              </svg>
              Fullscreen
            </button>
            <button class="control-btn" onclick="exportModel()">
              <svg
                width="18"
                height="18"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"
                />
              </svg>
              Share
            </button>
          </div>
        </div>
      </div>

      <!-- é™€èºä»ªæ–¹å‘æŒ‡ç¤ºçƒ -->
      <div id="gyro-indicator" class="gyro-indicator">
        <div id="gyro-ball" class="gyro-ball"></div>
        <div class="gyro-crosshair"></div>
      </div>
      <div id="gyro-hint" class="gyro-hint">Tilt to explore</div>

      <div class="tooltip" id="zoom-tooltip">
        Hold Shift + Scroll for Precision Zoom
      </div>
    </div>

    <script type="module">
      // --- Boot Sequence Integration ---
      try {
        log("Importing modules...");
        const THREE = await import("three");
        const { Viewer } = await import("@mkkellogg/gaussian-splats-3d");
        log("Modules imported successfully.", "success");

        window.THREE = THREE; // Expose for debugging
        window.Viewer = Viewer;
      } catch (e) {
        log("Module Import Failed: " + e.message, "error");
        throw e;
      }

      import * as THREE from "three";
      import { Viewer } from "@mkkellogg/gaussian-splats-3d";

      log("Initializing variables...");
      let viewer = null;
      let isLimitsOn = true;
      let pollInterval = null;

      // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      // â•‘                     ğŸ“· ç›¸æœºæ§åˆ¶é…ç½® (ç»Ÿä¸€è°ƒè¯•å…¥å£)                          â•‘
      // â•‘  ä¿®æ”¹æ­¤å¤„å‚æ•°ååˆ·æ–°é¡µé¢å³å¯ç”Ÿæ•ˆï¼Œæ‰€æœ‰ç›¸æœºè¡Œä¸ºç”±æ­¤é…ç½®æ§åˆ¶                      â•‘
      // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const CAMERA_CONFIG = {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ“ åˆå§‹ç›¸æœºä½ç½®
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        initialPosition: [0, 0, 1], // [x, y, z] åˆå§‹ç›¸æœºä½ç½®ï¼Œz è¶Šå¤§ç¦»æ¨¡å‹è¶Šè¿œ
        cameraUp: [0, -1, 0], // ç›¸æœºå‘ä¸Šæ–¹å‘å‘é‡ (Yè½´å‘ä¸‹æ˜¯ 3D é«˜æ–¯æƒ¯ä¾‹)

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ–±ï¸ é¼ æ ‡æŒ‰é’®æ˜ å°„
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // THREE.MOUSE.ROTATE = 0, THREE.MOUSE.PAN = 2, THREE.MOUSE.DOLLY = 1
        mouseButtons: {
          LEFT: "PAN", // å·¦é”®: 'ROTATE'(æ—‹è½¬) | 'PAN'(å¹³ç§») | 'DOLLY'(ç¼©æ”¾)
          MIDDLE: "DOLLY", // ä¸­é”®/æ»šè½®ç‚¹å‡»: é€šå¸¸æ˜¯ç¼©æ”¾
          RIGHT: "ROTATE", // å³é”®: é»˜è®¤æ”¹ä¸ºæ—‹è½¬
        },

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // âš¡ é€Ÿåº¦ä¸çµæ•åº¦
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        rotateSpeed: 1.0, // æ—‹è½¬é€Ÿåº¦ (1.0 = é»˜è®¤ï¼Œè¶Šå¤§è¶Šå¿«)
        panSpeed: 1.0, // å¹³ç§»é€Ÿåº¦ (1.0 = é»˜è®¤)
        zoomSpeed: 1.0, // ç¼©æ”¾é€Ÿåº¦ (1.0 = é»˜è®¤ï¼Œscroll wheel)
        keyPanSpeed: 7.0, // é”®ç›˜å¹³ç§»é€Ÿåº¦ (åƒç´ /æŒ‰é”®)

        // Shift é”®ç²¾ç»†æ§åˆ¶æ¨¡å¼
        precisionZoomSpeed: 0.3, // æŒ‰ä½ Shift æ—¶çš„ç¼©æ”¾é€Ÿåº¦ (æ›´ç²¾ç»†)

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ“ è·ç¦»é™åˆ¶ (ç¼©æ”¾èŒƒå›´)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        minDistance: 0.3, // æœ€å°ç¼©æ”¾è·ç¦» (é˜²æ­¢ç©¿æ¨¡)
        maxDistance: 10.0, // æœ€å¤§ç¼©æ”¾è·ç¦» (é˜²æ­¢æ¨¡å‹å¤ªå°)

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ”„ æ—‹è½¬è§’åº¦é™åˆ¶ (Front View æ¨¡å¼)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        limits: {
          // æ°´å¹³æ—‹è½¬é™åˆ¶ (å¼§åº¦åˆ¶, PI/4 = 45Â°)
          minAzimuth: -Math.PI / 4, // å·¦è¾¹ç•Œ: -45Â°
          maxAzimuth: Math.PI / 4, // å³è¾¹ç•Œ: +45Â°
          // å‚ç›´æ—‹è½¬é™åˆ¶
          minPolar: Math.PI / 3, // ä¸Šè¾¹ç•Œ: 60Â° (ä¸èƒ½çœ‹å¤ªé¡¶)
          maxPolar: (2 * Math.PI) / 3, // ä¸‹è¾¹ç•Œ: 120Â° (ä¸èƒ½çœ‹å¤ªåº•)
          // é™åˆ¶æ¨¡å¼ä¸‹çš„è·ç¦»èŒƒå›´
          minDist: 1.0,
          maxDist: 8.0,
        },

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ¯ è‡ªç”±è§†è§’æ¨¡å¼ (æ— é™åˆ¶)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        freeMode: {
          minAzimuth: -Infinity, // æ°´å¹³æ— é™åˆ¶
          maxAzimuth: Infinity,
          minPolar: 0, // å¯ä»¥çœ‹æ­£ä¸Šæ–¹
          maxPolar: Math.PI, // å¯ä»¥çœ‹æ­£ä¸‹æ–¹
          minDist: 0.1,
          maxDist: 20,
        },

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ¬ åŠ¨ç”»å‚æ•°
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        resetAnimationDuration: 800, // é‡ç½®ç›¸æœºåŠ¨ç”»æ—¶é•¿ (æ¯«ç§’)

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ”§ é˜»å°¼ (æƒ¯æ€§/å¹³æ»‘)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        enableDamping: true, // æ˜¯å¦å¯ç”¨é˜»å°¼ (æƒ¯æ€§æ»‘åŠ¨)
        dampingFactor: 0.05, // é˜»å°¼ç³»æ•° (0.01-0.1ï¼Œè¶Šå°è¶Šæ»‘)

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ”„ è‡ªåŠ¨æ—‹è½¬
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        autoRotate: false, // æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ—‹è½¬
        autoRotateSpeed: 2.0, // è‡ªåŠ¨æ—‹è½¬é€Ÿåº¦ (åº¦/ç§’ï¼Œè´Ÿæ•°åå‘)

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ“± è§¦æ‘¸å±é…ç½®
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        touches: {
          ONE: "ROTATE", // å•æŒ‡: 'ROTATE' | 'PAN' | 'DOLLY_PAN' | 'DOLLY_ROTATE'
          TWO: "DOLLY_PAN", // åŒæŒ‡: 'DOLLY_PAN' | 'DOLLY_ROTATE' | 'PAN' | 'ROTATE'
        },

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ¥ ç›¸æœºè§†é‡ (é€è§†æŠ•å½±)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        fov: 50, // è§†é‡è§’åº¦ (åº¦)ï¼Œè¶Šå¤§çœ‹åˆ°çš„è¶Šå¹¿
        near: 0.01, // è¿‘è£å‰ªé¢
        far: 1000, // è¿œè£å‰ªé¢

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ“¦ æ¨¡å‹åŠ è½½é…ç½®
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        modelScale: [2.0, 2.0, 2.0], // æ¨¡å‹ç¼©æ”¾ [x, y, z]
        modelRotation: [0, 1, 0, 0], // æ¨¡å‹æ—‹è½¬ (å››å…ƒæ•°)
      };

      // è¾…åŠ©å‡½æ•°ï¼šå°†é…ç½®çš„å­—ç¬¦ä¸²æ˜ å°„åˆ° THREE å¸¸é‡
      function getMouseButton(name) {
        const map = {
          ROTATE: THREE.MOUSE.ROTATE,
          PAN: THREE.MOUSE.PAN,
          DOLLY: THREE.MOUSE.DOLLY,
        };
        return map[name] ?? THREE.MOUSE.ROTATE;
      }
      function getTouchType(name) {
        const map = {
          ROTATE: THREE.TOUCH.ROTATE,
          PAN: THREE.TOUCH.PAN,
          DOLLY_PAN: THREE.TOUCH.DOLLY_PAN,
          DOLLY_ROTATE: THREE.TOUCH.DOLLY_ROTATE,
        };
        return map[name] ?? THREE.TOUCH.ROTATE;
      }
      let processedTaskIds = new Set(); // è®°å½•å·²å®Œæˆå¹¶å¤„ç†è¿‡çš„ä»»åŠ¡

      // UI å¼•ç”¨
      const galleryList = document.getElementById("gallery-list");
      const queueContainer = document.getElementById("queue-container");
      const queueList = document.getElementById("queue-list");
      const fileInput = document.getElementById("file-input");
      const overlay = document.getElementById("loading-overlay");
      const loadingText = document.getElementById("loading-text");
      const emptyState = document.getElementById("empty-state");
      const controlsBar = document.getElementById("controls-bar");
      const zoomTooltip = document.getElementById("zoom-tooltip");
      const canvasContainer = document.getElementById("canvas-container");
      const sidebar = document.getElementById("sidebar");
      const sidebarOverlay = document.getElementById("sidebar-overlay");

      // --- ç§»åŠ¨ç«¯ä¾§è¾¹æ æ§åˆ¶ ---
      window.toggleSidebar = function () {
        const isOpen = sidebar.classList.contains("open");
        if (isOpen) {
          sidebar.classList.remove("open");
          sidebarOverlay.classList.remove("visible");
          setTimeout(() => (sidebarOverlay.style.display = "none"), 300);
        } else {
          sidebarOverlay.style.display = "block";
          // å¼ºåˆ¶é‡ç»˜
          requestAnimationFrame(() => {
            sidebar.classList.add("open");
            sidebarOverlay.classList.add("visible");
          });
        }
      };

      // --- æ§åˆ¶æ æŠ˜å åˆ‡æ¢ ---
      const controlsWrapper = document.getElementById("controls-wrapper");

      window.toggleControlsBar = function () {
        controlsWrapper.classList.toggle("collapsed");
      };

      // --- æ“ä½œæŒ‡å—é¢æ¿åˆ‡æ¢ ---
      const helpPanel = document.getElementById("help-panel");
      const helpBtn = document.getElementById("help-btn");

      window.toggleHelpPanel = function () {
        helpPanel.classList.toggle("visible");
      };

      // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­å¸®åŠ©é¢æ¿
      document.addEventListener("click", function (e) {
        if (
          helpPanel.classList.contains("visible") &&
          !helpPanel.contains(e.target) &&
          !helpBtn.contains(e.target)
        ) {
          helpPanel.classList.remove("visible");
        }
      });

      // --- 1. Viewer åˆå§‹åŒ– ---
      function initViewer() {
        canvasContainer.innerHTML = "";
        viewer = new Viewer({
          cameraUp: CAMERA_CONFIG.cameraUp,
          initialCameraPosition: CAMERA_CONFIG.initialPosition,
          rootElement: canvasContainer,
          gpuAcceleratedSort: false,
          sharedMemoryForWorkers: false,
          useBuiltInControls: true,
          selfDrivenMode: true,
        });

        // åº”ç”¨æ‰€æœ‰ç›¸æœºæ§åˆ¶é…ç½®
        setTimeout(() => {
          const c = viewer.cameraControls || viewer.controls;
          if (!c) return;

          // ğŸ–±ï¸ é¼ æ ‡æŒ‰é’®æ˜ å°„
          if (c.mouseButtons) {
            c.mouseButtons.LEFT = getMouseButton(
              CAMERA_CONFIG.mouseButtons.LEFT
            );
            c.mouseButtons.MIDDLE = getMouseButton(
              CAMERA_CONFIG.mouseButtons.MIDDLE
            );
            c.mouseButtons.RIGHT = getMouseButton(
              CAMERA_CONFIG.mouseButtons.RIGHT
            );
          }

          // ğŸ“± è§¦æ‘¸å±é…ç½®
          if (c.touches) {
            c.touches.ONE = getTouchType(CAMERA_CONFIG.touches.ONE);
            c.touches.TWO = getTouchType(CAMERA_CONFIG.touches.TWO);
          }

          // âš¡ é€Ÿåº¦é…ç½®
          c.rotateSpeed = CAMERA_CONFIG.rotateSpeed;
          c.panSpeed = CAMERA_CONFIG.panSpeed;
          c.zoomSpeed = CAMERA_CONFIG.zoomSpeed;
          if (c.keyPanSpeed !== undefined)
            c.keyPanSpeed = CAMERA_CONFIG.keyPanSpeed;

          // ğŸ“ è·ç¦»é™åˆ¶
          c.minDistance = CAMERA_CONFIG.minDistance;
          c.maxDistance = CAMERA_CONFIG.maxDistance;

          // ğŸ”§ é˜»å°¼ (æƒ¯æ€§)
          c.enableDamping = CAMERA_CONFIG.enableDamping;
          c.dampingFactor = CAMERA_CONFIG.dampingFactor;

          // ğŸ”„ è‡ªåŠ¨æ—‹è½¬
          c.autoRotate = CAMERA_CONFIG.autoRotate;
          c.autoRotateSpeed = CAMERA_CONFIG.autoRotateSpeed;

          c.update();
        }, 100);
      }

      // --- 2. åŠ è½½æ¨¡å‹é€»è¾‘ ---
      async function loadModel(url) {
        emptyState.style.display = "none";
        showLoading("Loading Scene...");
        updateProgress(0, true); // å¼ºåˆ¶é‡ç½®è¿›åº¦
        if (window.hideParticles) hideParticles(); // éšè—ç²’å­èƒŒæ™¯

        // ä¿®å¤ï¼šå›é€€åˆ°é”€æ¯é‡å»ºæ¨¡å¼ï¼Œè§£å†³æ¨¡å‹é‡å é—®é¢˜
        if (viewer) {
          try {
            if (viewer.dispose) viewer.dispose();
          } catch (e) {}
          viewer = null;
        }
        initViewer();

        try {
          await viewer.addSplatScene(url, {
            showLoadingUI: false,
            position: [0, 0, 0],
            rotation: [0, 1, 0, 0],
            scale: [2.0, 2.0, 2.0],
            onProgress: (percent, message, stage) => {
              updateProgress(percent);
            },
          });

          updateProgress(100);
          hideLoading();
          controlsBar.style.display = "flex";
          viewer.start();
          applyLimits();

          // é‡ç½®ç›¸æœºåˆ°æ–°çš„åˆå§‹ä½ç½®
          const c = viewer.cameraControls || viewer.controls;
          if (c) {
            c.reset(); // é‡ç½®åˆ° initialCameraPosition
          }
        } catch (e) {
          hideLoading();
          console.error("Viewer Error:", e);
          alert("Viewer Error: " + e.message);
        }
      }

      // æ›´æ–°è¿›åº¦æ¡ï¼ˆåªå…è®¸å¢åŠ ï¼Œé˜²æ­¢è·³å˜ï¼‰
      let maxProgress = 0;
      function updateProgress(percent, forceReset = false) {
        if (forceReset) {
          maxProgress = 0;
        }
        // åªå…è®¸è¿›åº¦å¢åŠ ï¼Œå¿½ç•¥å›é€€
        if (percent > maxProgress) {
          maxProgress = percent;
        }
        const progressBar = document.getElementById("loading-progress-bar");
        const percentText = document.getElementById("loading-percent");
        if (progressBar) {
          progressBar.style.width = maxProgress + "%";
        }
        if (percentText) {
          percentText.textContent = Math.round(maxProgress) + "%";
        }
      }

      // --- 3. UI äº¤äº’é€»è¾‘ ---

      function showLoading(text) {
        loadingText.innerText = text;
        overlay.style.display = "flex";
        requestAnimationFrame(() => overlay.classList.add("visible"));
      }
      function hideLoading() {
        overlay.classList.remove("visible");
        setTimeout(() => (overlay.style.display = "none"), 300);
      }

      // åˆ·æ–°å›¾åº“
      async function refreshGallery() {
        log("Refreshing gallery...");
        try {
          const res = await fetch("/api/gallery");
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          const items = await res.json();
          renderGallery(items);
          log(`Gallery loaded with ${items.length} items.`, "success");

          // App is ready
          if (document.getElementById("boot-screen")) {
            setTimeout(() => {
              document.getElementById("boot-screen").style.display = "none";
            }, 500);
          }
        } catch (e) {
          log("Gallery Fetch Failed: " + e.message, "error");
          console.error("Gallery Fetch Failed", e);
        }
      }

      function renderGallery(items) {
        galleryList.innerHTML = "";
        items.forEach((item) => {
          const div = document.createElement("div");
          div.className = "gallery-item";
          div.dataset.itemId = item.id; // ç”¨äºåˆ é™¤åŠ¨ç”»
          // è®¡ç®—æ–‡ä»¶å¤§å°æ˜¾ç¤º
          const sizeText = item.size ? formatFileSize(item.size) : "";
          // ä½¿ç”¨ç¼©ç•¥å›¾ URLï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
          const thumbSrc = item.thumb_url || item.image_url || "";
          div.innerHTML = `
                    <img src="${thumbSrc}" class="thumb" loading="lazy" onerror="this.style.background='#eee'">
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-date">${sizeText || "Ready"}</div>
                    </div>
                    ${
                      item.image_url
                        ? `<button class="btn-preview" title="View Original" onclick="event.stopPropagation(); previewImage('${item.image_url}')">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </button>`
                        : ""
                    }
                    <button class="btn-download" title="Download" onclick="event.stopPropagation(); downloadModel('${
                      item.id
                    }')">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                    </button>
                    <button class="btn-delete" title="Delete" onclick="event.stopPropagation(); deleteItem('${
                      item.id
                    }')">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
          div.onclick = () => {
            document
              .querySelectorAll(".gallery-item")
              .forEach((el) => el.classList.remove("active"));
            div.classList.add("active");
            currentModelId = item.id; // è®°å½•å½“å‰æ¨¡å‹ IDï¼Œç”¨äºåˆ†äº«
            loadModel(item.model_url);

            // ç§»åŠ¨ç«¯ç‚¹å‡»åè‡ªåŠ¨æ”¶èµ·ä¾§è¾¹æ 
            if (window.innerWidth <= 768) {
              toggleSidebar();
            }
          };
          galleryList.appendChild(div);
        });
      }

      // æ–‡ä»¶å¤§å°æ ¼å¼åŒ–
      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + " B";
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
        return (bytes / (1024 * 1024)).toFixed(1) + " MB";
      }

      // ä¸‹è½½æ¨¡å‹
      window.downloadModel = function (id) {
        window.location.href = `/api/download/${id}`;
      };

      // åˆ é™¤åŠŸèƒ½ (å¸¦åŠ¨ç”»)
      window.deleteItem = async function (id) {
        if (!confirm("Are you sure you want to delete this item?")) return;

        // æ‰¾åˆ°å¯¹åº”çš„ gallery-item å¹¶æ·»åŠ åˆ é™¤åŠ¨ç”»
        const itemEl = document.querySelector(
          `.gallery-item[data-item-id="${id}"]`
        );
        if (itemEl) {
          itemEl.classList.add("deleting");
        }

        // ç­‰å¾…åŠ¨ç”»å®Œæˆåå†æ‰§è¡Œåˆ é™¤
        setTimeout(async () => {
          try {
            const res = await fetch(`/api/delete/${id}`, { method: "DELETE" });
            const data = await res.json();
            if (data.success) {
              refreshGallery();
            } else {
              if (itemEl) itemEl.classList.remove("deleting");
              alert("Delete failed: " + data.error);
            }
          } catch (e) {
            if (itemEl) itemEl.classList.remove("deleting");
            alert("Error deleting item: " + e.message);
          }
        }, 300); // ç­‰å¾…åŠ¨ç”»æ—¶é—´
      };

      // å…¨å±åˆ‡æ¢
      window.toggleFullscreen = function () {
        const mainContent = document.getElementById("main-content");
        const btn = document.getElementById("btn-fullscreen");

        if (!document.fullscreenElement) {
          // è¿›å…¥å…¨å±
          if (mainContent.requestFullscreen) {
            mainContent.requestFullscreen();
          } else if (mainContent.webkitRequestFullscreen) {
            mainContent.webkitRequestFullscreen(); // Safari
          }
          btn.classList.add("active");
          btn.innerHTML = `
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    Exit
                `;
        } else {
          // é€€å‡ºå…¨å±
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen(); // Safari
          }
          btn.classList.remove("active");
          btn.innerHTML = `
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                    </svg>
                    Fullscreen
                `;
        }
      };

      // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–
      document.addEventListener("fullscreenchange", () => {
        if (!document.fullscreenElement) {
          const btn = document.getElementById("btn-fullscreen");
          if (btn) {
            btn.classList.remove("active");
            btn.innerHTML = `
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                        </svg>
                        Fullscreen
                    `;
          }
        }
      });

      // å½“å‰é€‰ä¸­çš„æ¨¡å‹ ID
      let currentModelId = null;

      // å¯¼å‡ºåˆ†äº« HTML
      window.exportModel = async function () {
        if (!currentModelId) {
          alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡å‹");
          return;
        }

        showLoading("Preparing export...");
        updateProgress(0, true); // é‡ç½®è¿›åº¦æ¡

        // æ¨¡æ‹Ÿè¿›åº¦ (åç«¯è½¬æ¢å’Œå‹ç¼©éœ€è¦æ—¶é—´)
        let progress = 5;
        updateProgress(progress);
        const progressInterval = setInterval(() => {
          progress += (85 - progress) * 0.05; // æ¸è¿›å¼è¿›åº¦
          updateProgress(progress);

          // æ›´æ–°æç¤ºæ–‡å­—
          if (progress < 20) {
            document.getElementById("loading-text").textContent =
              "Converting model format...";
          } else if (progress < 60) {
            document.getElementById("loading-text").textContent =
              "Optimizing data...";
          } else {
            document.getElementById("loading-text").textContent =
              "Generating HTML...";
          }
        }, 200);

        try {
          const response = await fetch(`/api/export/${currentModelId}`);
          clearInterval(progressInterval);

          if (!response.ok) {
            throw new Error("Export failed");
          }

          updateProgress(95);
          document.getElementById("loading-text").textContent =
            "Downloading...";

          const blob = await response.blob();
          const url = URL.createObjectURL(blob);

          // è§¦å‘ä¸‹è½½
          const a = document.createElement("a");
          a.href = url;
          a.download = `${currentModelId}_share.html`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          updateProgress(100);
          setTimeout(() => hideLoading(), 300);
        } catch (e) {
          clearInterval(progressInterval);
          hideLoading();
          alert("å¯¼å‡ºå¤±è´¥: " + e.message);
        }
      };

      // ç»Ÿä¸€ä¸Šä¼ å¤„ç†å‡½æ•°
      async function handleUpload(files) {
        if (!files.length) return;

        const formData = new FormData();
        let hasFiles = false;
        for (let i = 0; i < files.length; i++) {
          if (files[i].type.startsWith("image/")) {
            formData.append("file", files[i]);
            hasFiles = true;
          }
        }

        if (!hasFiles) {
          alert("Please select image files.");
          return;
        }

        try {
          const res = await fetch("/api/generate", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();

          if (data.success) {
            // å¼€å§‹è½®è¯¢
            startPolling();
          } else {
            alert("Upload Failed: " + data.error);
          }
        } catch (err) {
          alert("Network Error: " + err.message);
        }
      }

      // ä¸Šä¼ ç”Ÿæˆ (æ‰¹é‡) - æ–‡ä»¶é€‰æ‹©
      fileInput.addEventListener("change", async (e) => {
        handleUpload(e.target.files);
        fileInput.value = ""; // é‡ç½® input
      });

      // --- æ‹–æ‹½ä¸Šä¼ æ”¯æŒ ---
      // const sidebar = document.getElementById('sidebar'); // å·²ç»åœ¨ä¸Šé¢å®šä¹‰äº†

      sidebar.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.stopPropagation();
        sidebar.classList.add("drag-over");
      });

      sidebar.addEventListener("dragleave", (e) => {
        e.preventDefault();
        e.stopPropagation();
        // åªæœ‰å½“ç¦»å¼€ sidebar æœ¬èº«è€Œä¸æ˜¯è¿›å…¥å­å…ƒç´ æ—¶æ‰ç§»é™¤
        if (e.relatedTarget && !sidebar.contains(e.relatedTarget)) {
          sidebar.classList.remove("drag-over");
        }
      });

      sidebar.addEventListener("drop", (e) => {
        e.preventDefault();
        e.stopPropagation();
        sidebar.classList.remove("drag-over");

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleUpload(files);
        }
      });

      // --- 4. é˜Ÿåˆ—è½®è¯¢ç³»ç»Ÿ (æ™ºèƒ½è½®è¯¢ç‰ˆ) ---
      let pollTimeout = null;
      let currentPollDelay = 2000;
      const POLL_DELAY_ACTIVE = 2000; // æœ‰ä»»åŠ¡æ—¶ 2ç§’
      const POLL_DELAY_IDLE = 10000; // æ— ä»»åŠ¡æ—¶ 10ç§’

      function startPolling() {
        if (pollTimeout) return;
        pollTasks(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
      }

      async function pollTasks() {
        try {
          const res = await fetch("/api/tasks");
          const data = await res.json();
          const tasks = data.tasks || data; // å…¼å®¹æ–°æ—§æ ¼å¼
          const hasActive =
            data.has_active !== undefined
              ? data.has_active
              : tasks.some(
                  (t) => t.status === "pending" || t.status === "processing"
                );

          renderQueue(tasks);

          // æ™ºèƒ½è°ƒæ•´è½®è¯¢é¢‘ç‡
          currentPollDelay = hasActive ? POLL_DELAY_ACTIVE : POLL_DELAY_IDLE;
        } catch (e) {
          console.error("Poll Error", e);
        }

        // ä½¿ç”¨ setTimeout è€Œä¸æ˜¯ setIntervalï¼Œæ–¹ä¾¿åŠ¨æ€è°ƒæ•´é—´éš”
        pollTimeout = setTimeout(pollTasks, currentPollDelay);
      }

      function renderQueue(tasks) {
        // è¿‡æ»¤æ‰å·²ç»å®Œæˆå¾ˆä¹…çš„ä»»åŠ¡ (å¯é€‰ä¼˜åŒ–ï¼Œè¿™é‡Œç®€å•å±•ç¤ºæ‰€æœ‰éå®Œæˆæˆ–åˆšå®Œæˆçš„ä»»åŠ¡)
        // ç®€å•ç­–ç•¥ï¼šåªå±•ç¤º pending, processing, å’Œ failedã€‚completed å±•ç¤ºä¸€ä¼šåç§»é™¤?
        // ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å±•ç¤ºæ‰€æœ‰ pending/processingï¼Œä»¥åŠæœ€è¿‘å®Œæˆçš„

        const activeTasks = tasks.filter((t) => {
          if (t.status === "pending" || t.status === "processing") return true;
          if (t.status === "failed") return true;
          // å¦‚æœæ˜¯ completedï¼Œä¸”è¿˜æ²¡è¢«å¤„ç†è¿‡(åˆ·æ–°å›¾åº“)ï¼Œåˆ™å±•ç¤º
          if (t.status === "completed" && !processedTaskIds.has(t.id)) {
            processedTaskIds.add(t.id);
            refreshGallery(); // è§¦å‘å›¾åº“åˆ·æ–°
            return true; // å±•ç¤ºæœ€åä¸€æ¬¡ "Done"
          }
          return false; // å·²ç»å¤„ç†è¿‡çš„ completed ä»»åŠ¡ä¸å†æ˜¾ç¤ºåœ¨é˜Ÿåˆ—ä¸­
        });

        if (activeTasks.length === 0) {
          queueContainer.style.display = "none";
          return;
        }

        queueContainer.style.display = "block";
        queueList.innerHTML = "";

        activeTasks.forEach((task) => {
          const div = document.createElement("div");
          div.className = "queue-item";

          let icon = "";
          let statusColor = "#666";

          if (task.status === "pending") {
            icon =
              '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            statusColor = "#f0ad4e";
          } else if (task.status === "processing") {
            icon =
              '<svg class="spin" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';
            statusColor = "#0071e3";
          } else if (task.status === "completed") {
            icon =
              '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
            statusColor = "#28a745";
          } else if (task.status === "failed") {
            icon =
              '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
            statusColor = "#dc3545";
          }

          div.innerHTML = `
                    <div class="queue-status-icon" style="color: ${statusColor}">${icon}</div>
                    <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${task.filename}</div>
                    <div style="font-size:10px; color:#888; text-transform:capitalize;">${task.status}</div>
                `;
          queueList.appendChild(div);
        });
      }

      // --- 5. ç›¸æœºæ§åˆ¶ ---

      window.toggleLimits = function () {
        if (!viewer) return;
        isLimitsOn = !isLimitsOn;
        const btn = document.getElementById("btn-limit");
        btn.classList.toggle("active", isLimitsOn);
        btn.innerHTML = isLimitsOn
          ? `<svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg> Front View`
          : `<svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg> Free View`;
        applyLimits();
      };

      window.resetCamera = function () {
        if (viewer) {
          const c = viewer.cameraControls || viewer.controls;
          if (c) {
            // 1. Capture current state
            const startPos = new THREE.Vector3().copy(c.object.position);
            const startTarget = new THREE.Vector3().copy(c.target);

            // 2. Reset to get target state (instant)
            c.reset();
            const endPos = new THREE.Vector3().copy(c.object.position);
            const endTarget = new THREE.Vector3().copy(c.target);

            // 3. Restore current state immediately
            c.object.position.copy(startPos);
            c.target.copy(startTarget);
            c.update();

            // 4. Animate
            const duration = 800;
            const startTime = performance.now();

            function animateReset(time) {
              const elapsed = time - startTime;
              const t = Math.min(elapsed / duration, 1);
              // Ease out cubic
              const ease = 1 - Math.pow(1 - t, 3);

              c.object.position.lerpVectors(startPos, endPos, ease);
              c.target.lerpVectors(startTarget, endTarget, ease);
              c.update();

              if (t < 1) {
                requestAnimationFrame(animateReset);
              } else {
                // Ensure final state
                c.object.position.copy(endPos);
                c.target.copy(endTarget);
                c.update();
                applyLimits();
              }
            }
            requestAnimationFrame(animateReset);
          }
        }
      };

      function applyLimits() {
        if (!viewer) return;
        const c = viewer.cameraControls || viewer.controls;
        if (!c) return;

        // æ ¹æ® isLimitsOn çŠ¶æ€é€‰æ‹©é…ç½®
        const cfg = isLimitsOn ? CAMERA_CONFIG.limits : CAMERA_CONFIG.freeMode;

        c.minAzimuthAngle = cfg.minAzimuth;
        c.maxAzimuthAngle = cfg.maxAzimuth;
        c.minPolarAngle = cfg.minPolar;
        c.maxPolarAngle = cfg.maxPolar;
        c.minDistance = cfg.minDist;
        c.maxDistance = cfg.maxDist;

        c.update();
      }

      // Shift å¾®è°ƒç¼©æ”¾ (ä¿®å¤ macOS Shift+Scroll é—®é¢˜)
      window.addEventListener("keydown", (e) => {
        if (e.key === "Shift" && viewer) {
          const c = viewer.cameraControls || viewer.controls;
          if (c) {
            c.zoomSpeed = CAMERA_CONFIG.precisionZoomSpeed;
            zoomTooltip.classList.add("show");
          }
        }
      });
      window.addEventListener("keyup", (e) => {
        if (e.key === "Shift" && viewer) {
          const c = viewer.cameraControls || viewer.controls;
          if (c) {
            c.zoomSpeed = CAMERA_CONFIG.zoomSpeed;
            zoomTooltip.classList.remove("show");
          }
        }
      });

      // æ‹¦æˆª Shift+Scroll äº‹ä»¶ï¼Œè§£å†³ macOS ä¸‹è¢«æ˜ å°„ä¸ºæ°´å¹³æ»šåŠ¨çš„é—®é¢˜
      canvasContainer.addEventListener(
        "wheel",
        (e) => {
          if (e.shiftKey) {
            e.preventDefault();
            e.stopPropagation();

            // åœ¨ macOS ä¸Šï¼ŒæŒ‰ä½ Shift æ»šåŠ¨é€šå¸¸ä¼šå°† deltaY æ˜ å°„åˆ° deltaX
            // æˆ‘ä»¬éœ€è¦æ£€æµ‹è¿™ç§æƒ…å†µå¹¶å°†å…¶è¿˜åŸä¸ºå‚ç›´æ»šåŠ¨ï¼Œä»¥ä¾¿ OrbitControls èƒ½è¯†åˆ«ä¸ºç¼©æ”¾
            let deltaY = e.deltaY;
            if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
              deltaY = e.deltaX;
            }

            // åˆ›å»ºåˆæˆäº‹ä»¶ï¼šç§»é™¤ shiftKeyï¼Œå¹¶å°† delta ä¿®æ­£ä¸ºå‚ç›´æ–¹å‘
            const newEvent = new WheelEvent("wheel", {
              bubbles: true,
              cancelable: true,
              view: window,
              deltaX: 0,
              deltaY: deltaY,
              deltaZ: e.deltaZ,
              deltaMode: e.deltaMode,
              clientX: e.clientX,
              clientY: e.clientY,
              screenX: e.screenX,
              screenY: e.screenY,
              shiftKey: false, // å…³é”®ï¼šç¦ç”¨ shiftKey è®©æ§ä»¶è®¤ä¸ºæ˜¯æ™®é€šæ»šåŠ¨
              ctrlKey: e.ctrlKey,
              altKey: e.altKey,
              metaKey: e.metaKey,
            });

            e.target.dispatchEvent(newEvent);
          }
        },
        { capture: true }
      ); // ä½¿ç”¨æ•è·é˜¶æ®µæ‹¦æˆªäº‹ä»¶

      // --- Mobile Debugging ---
      canvasContainer.addEventListener(
        "touchstart",
        (e) => {
          // log(`Touch start: ${e.touches.length} fingers`);
        },
        { passive: true }
      );

      document.getElementById("btn-menu").addEventListener("click", () => {
        log("Menu button clicked");
      });

      // --- 6. é™€èºä»ªä½“æ„Ÿæ§åˆ¶ç³»ç»Ÿ (iOS 26 é£æ ¼) ---

      const gyroManager = {
        isEnabled: false,
        isSupported: false,
        isPaused: false,
        needsCalibration: true, // æ˜¯å¦éœ€è¦æ ¡å‡†ï¼ˆé¦–æ¬¡å¯ç”¨æ—¶ï¼‰

        // åŸå§‹ä¼ æ„Ÿå™¨æ•°æ®
        alpha: 0,
        beta: 0,
        gamma: 0,

        // å¹³æ»‘åçš„ç›®æ ‡å€¼
        targetAzimuth: 0,
        targetPolar: Math.PI / 2,

        // å½“å‰å¹³æ»‘å€¼
        smoothAzimuth: 0,
        smoothPolar: Math.PI / 2,

        // é…ç½®
        dampingFactor: 0.08, // é˜»å°¼ç³»æ•°ï¼Œè¶Šå°è¶Šå¹³æ»‘
        maxTiltAngle: 35, // æœ€å¤§å€¾æ–œæ£€æµ‹è§’åº¦
        sensitivity: 1.0, // çµæ•åº¦

        // å‚è€ƒè§’åº¦ï¼ˆç‚¹å‡»æŒ‰é’®æ—¶çš„è®¾å¤‡å§¿æ€ï¼‰
        refBeta: 0,
        refGamma: 0,

        // UI å…ƒç´ 
        indicator: null,
        ball: null,
        hint: null,
        btn: null,

        // åŠ¨ç”»
        animationId: null,
        touchTimeout: null,
      };

      // åˆå§‹åŒ–é™€èºä»ª UI å¼•ç”¨
      gyroManager.indicator = document.getElementById("gyro-indicator");
      gyroManager.ball = document.getElementById("gyro-ball");
      gyroManager.hint = document.getElementById("gyro-hint");
      gyroManager.btn = document.getElementById("btn-gyro");

      // æ£€æµ‹è®¾å¤‡æ˜¯å¦æ”¯æŒé™€èºä»ª
      gyroManager.isSupported = "DeviceOrientationEvent" in window;

      // è¯·æ±‚é™€èºä»ªæƒé™ (iOS 13+ éœ€è¦)
      async function requestGyroPermission() {
        // iOS 13+ éœ€è¦ç”¨æˆ·æˆæƒ
        if (typeof DeviceOrientationEvent.requestPermission === "function") {
          try {
            const permission = await DeviceOrientationEvent.requestPermission();
            if (permission === "granted") {
              log("Gyroscope permission granted", "success");
              return true;
            } else {
              log("Gyroscope permission denied", "error");
              alert("éœ€è¦é™€èºä»ªæƒé™æ‰èƒ½ä½¿ç”¨ä½“æ„Ÿé¢„è§ˆåŠŸèƒ½");
              return false;
            }
          } catch (e) {
            log("Gyroscope permission error: " + e.message, "error");
            return false;
          }
        }
        // Android å’Œæ—§ç‰ˆ iOS ä¸éœ€è¦ç‰¹åˆ«æˆæƒ
        return true;
      }

      // å¤„ç†é™€èºä»ªæ•°æ®
      function handleDeviceOrientation(event) {
        if (!gyroManager.isEnabled || gyroManager.isPaused) return;

        gyroManager.alpha = event.alpha || 0; // æŒ‡å—é’ˆæ–¹å‘ (0-360)
        gyroManager.beta = event.beta || 0; // å‰åå€¾æ–œ (-180 to 180)
        gyroManager.gamma = event.gamma || 0; // å·¦å³å€¾æ–œ (-90 to 90)

        // å°†å€¾æ–œè§’åº¦æ˜ å°„åˆ°ç›¸æœºè§’åº¦
        // Beta: æ‰‹æœºå‰åå€¾æ–œ -> ç›¸æœºä¸Šä¸‹çœ‹
        // Gamma: æ‰‹æœºå·¦å³å€¾æ–œ -> ç›¸æœºå·¦å³çœ‹

        const maxTilt = gyroManager.maxTiltAngle;

        // é¦–æ¬¡æ•°æ®æ—¶æ ¡å‡†å‚è€ƒè§’åº¦
        if (gyroManager.needsCalibration) {
          gyroManager.refBeta = gyroManager.beta;
          gyroManager.refGamma = gyroManager.gamma;
          gyroManager.needsCalibration = false;
        }

        // ç›¸å¯¹äºå‚è€ƒè§’åº¦çš„åç§»
        let normalizedBeta = gyroManager.beta - gyroManager.refBeta;
        normalizedBeta = Math.max(-maxTilt, Math.min(maxTilt, normalizedBeta));

        let normalizedGamma = gyroManager.gamma - gyroManager.refGamma;
        normalizedGamma = Math.max(
          -maxTilt,
          Math.min(maxTilt, normalizedGamma)
        );

        // æ˜ å°„åˆ°ç›¸æœºè§’åº¦èŒƒå›´
        // Azimuth: Â±45åº¦ (å·¦å³)
        // Polar: 60åº¦ ~ 120åº¦ (ä¸Šä¸‹)
        gyroManager.targetAzimuth =
          (normalizedGamma / maxTilt) * (Math.PI / 4) * gyroManager.sensitivity;
        gyroManager.targetPolar =
          Math.PI / 2 +
          (normalizedBeta / maxTilt) * (Math.PI / 6) * gyroManager.sensitivity;
      }

      // é™€èºä»ªæ¸²æŸ“å¾ªç¯
      function gyroRenderLoop() {
        if (!gyroManager.isEnabled) return;

        // å¹³æ»‘æ’å€¼
        gyroManager.smoothAzimuth +=
          (gyroManager.targetAzimuth - gyroManager.smoothAzimuth) *
          gyroManager.dampingFactor;
        gyroManager.smoothPolar +=
          (gyroManager.targetPolar - gyroManager.smoothPolar) *
          gyroManager.dampingFactor;

        // æ›´æ–°ç›¸æœº
        if (viewer && !gyroManager.isPaused) {
          const c = viewer.cameraControls || viewer.controls;
          if (c && c.object) {
            // è®¡ç®—ç›¸æœºä½ç½®
            const distance = c.object.position.distanceTo(c.target);
            const x =
              distance *
              Math.sin(gyroManager.smoothPolar) *
              Math.sin(gyroManager.smoothAzimuth);
            const y = distance * Math.cos(gyroManager.smoothPolar);
            const z =
              distance *
              Math.sin(gyroManager.smoothPolar) *
              Math.cos(gyroManager.smoothAzimuth);

            c.object.position.set(
              c.target.x + x,
              c.target.y + y,
              c.target.z + z
            );
            c.object.lookAt(c.target);
            c.update();
          }
        }

        // æ›´æ–°æŒ‡ç¤ºçƒ
        updateIndicatorBall();

        gyroManager.animationId = requestAnimationFrame(gyroRenderLoop);
      }

      // æ›´æ–°æ–¹å‘æŒ‡ç¤ºçƒ
      function updateIndicatorBall() {
        if (!gyroManager.ball) return;

        // å°†è§’åº¦æ˜ å°„åˆ°çƒçš„ä½ç§» (æœ€å¤§ 20px)
        const maxOffset = 18;
        const xOffset = (gyroManager.smoothAzimuth / (Math.PI / 4)) * maxOffset;
        const yOffset =
          ((gyroManager.smoothPolar - Math.PI / 2) / (Math.PI / 6)) * maxOffset;

        gyroManager.ball.style.transform = `translate(${xOffset}px, ${yOffset}px)`;
      }

      // åˆ‡æ¢é™€èºä»ªæ¨¡å¼
      window.toggleGyroMode = async function () {
        if (!gyroManager.isSupported) {
          alert("æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒé™€èºä»ª");
          return;
        }

        if (!viewer) {
          alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ª 3D æ¨¡å‹");
          return;
        }

        if (gyroManager.isEnabled) {
          // å…³é—­é™€èºä»ª
          disableGyro();
        } else {
          // å¼€å¯é™€èºä»ª
          const hasPermission = await requestGyroPermission();
          if (hasPermission) {
            enableGyro();
          }
        }
      };

      function enableGyro() {
        gyroManager.isEnabled = true;
        gyroManager.isPaused = false;
        gyroManager.needsCalibration = true; // å¯ç”¨æ—¶æ ‡è®°éœ€è¦æ ¡å‡†

        // é‡ç½®å¹³æ»‘å€¼
        gyroManager.smoothAzimuth = 0;
        gyroManager.smoothPolar = Math.PI / 2;
        gyroManager.targetAzimuth = 0;
        gyroManager.targetPolar = Math.PI / 2;

        // æ·»åŠ äº‹ä»¶ç›‘å¬
        window.addEventListener("deviceorientation", handleDeviceOrientation);

        // å¯åŠ¨æ¸²æŸ“å¾ªç¯
        gyroRenderLoop();

        // æ›´æ–° UI
        gyroManager.btn.classList.add("active");
        gyroManager.indicator.classList.add("visible");
        gyroManager.indicator.classList.add("active");

        // æ˜¾ç¤ºæç¤º
        gyroManager.hint.classList.add("show");
        setTimeout(() => {
          gyroManager.hint.classList.remove("show");
        }, 2500);

        // é™åˆ¶è§†è§’æ¨¡å¼ä¸‹ä½¿ç”¨é™€èºä»ª
        if (!isLimitsOn) {
          toggleLimits();
        }

        log("Gyroscope mode enabled", "success");
      }

      function disableGyro() {
        gyroManager.isEnabled = false;

        // ç§»é™¤äº‹ä»¶ç›‘å¬
        window.removeEventListener(
          "deviceorientation",
          handleDeviceOrientation
        );

        // åœæ­¢æ¸²æŸ“å¾ªç¯
        if (gyroManager.animationId) {
          cancelAnimationFrame(gyroManager.animationId);
          gyroManager.animationId = null;
        }

        // æ›´æ–° UI
        gyroManager.btn.classList.remove("active");
        gyroManager.indicator.classList.remove("visible");
        gyroManager.indicator.classList.remove("active");

        log("Gyroscope mode disabled");
      }

      // è§¦æ‘¸æ—¶æš‚åœé™€èºä»ªï¼Œè®©ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨è°ƒæ•´
      canvasContainer.addEventListener(
        "touchstart",
        (e) => {
          if (gyroManager.isEnabled && e.touches.length === 1) {
            gyroManager.isPaused = true;
            gyroManager.indicator.classList.remove("active");

            // æ¸…é™¤ä¹‹å‰çš„æ¢å¤å®šæ—¶å™¨
            if (gyroManager.touchTimeout) {
              clearTimeout(gyroManager.touchTimeout);
            }
          }
        },
        { passive: true }
      );

      canvasContainer.addEventListener(
        "touchend",
        (e) => {
          if (gyroManager.isEnabled && e.touches.length === 0) {
            // æ¾æ‰‹åå»¶è¿Ÿæ¢å¤é™€èºä»ªæ§åˆ¶
            gyroManager.touchTimeout = setTimeout(() => {
              if (gyroManager.isEnabled) {
                gyroManager.isPaused = false;
                gyroManager.indicator.classList.add("active");

                // ä»å½“å‰ç›¸æœºä½ç½®åŒæ­¥åˆ°é™€èºä»ªçŠ¶æ€
                if (viewer) {
                  const c = viewer.cameraControls || viewer.controls;
                  if (c && c.object) {
                    const pos = c.object.position.clone().sub(c.target);
                    const distance = pos.length();
                    if (distance > 0) {
                      // è®¡ç®—å½“å‰ç›¸æœºçš„æ–¹ä½è§’å’Œæè§’
                      gyroManager.smoothAzimuth = Math.atan2(pos.x, pos.z);
                      gyroManager.smoothPolar = Math.acos(pos.y / distance);
                      gyroManager.targetAzimuth = gyroManager.smoothAzimuth;
                      gyroManager.targetPolar = gyroManager.smoothPolar;
                    }
                  }
                }
              }
            }, 1500);
          }
        },
        { passive: true }
      );

      // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶å¤„ç†é™€èºä»ª
      document.addEventListener("visibilitychange", () => {
        if (document.hidden && gyroManager.isEnabled) {
          gyroManager.isPaused = true;
        } else if (!document.hidden && gyroManager.isEnabled) {
          gyroManager.isPaused = false;
        }
      });

      // åˆå§‹è¿è¡Œ
      log("Starting application...");
      refreshGallery();
      startPolling(); // é¡µé¢åŠ è½½æ—¶ä¹Ÿæ£€æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰æœªå®Œæˆçš„ä»»åŠ¡

      // æ£€æŸ¥æ˜¯å¦ä¸ºæœ¬æœºè®¿é—®ï¼Œæ˜¾ç¤ºè®¾ç½®æŒ‰é’®
      checkLocalAccess();

      // --- ç²’å­èƒŒæ™¯åŠ¨ç”» ---
      (function initParticles() {
        const canvas = document.getElementById("particle-canvas");
        if (!canvas) return;

        const ctx = canvas.getContext("2d");
        let particles = [];
        let mouseX = -1000,
          mouseY = -1000; // åˆå§‹åœ¨ç”»é¢å¤–
        let animationId = null;
        let time = 0;

        // ç²’å­é…ç½®
        const config = {
          baseCount: 250, // åŸºç¡€æ•°é‡ï¼ˆå¢åŠ ï¼‰
          minCount: 150, // æœ€å°æ•°é‡ï¼ˆç§»åŠ¨ç«¯ï¼‰
          maxCount: 300, // æœ€å¤§æ•°é‡ï¼ˆå¤§å±ï¼‰
          baseRadius: 2,
          maxRadius: 4,
          floatSpeed: 0.5, // è‡ªç„¶æµ®åŠ¨é€Ÿåº¦
          floatAmplitude: 25, // æµ®åŠ¨å¹…åº¦
          mouseRadius: 100,
          mouseForce: 0.06,
          resetSpeed: 0.001, // å¤ä½é€Ÿåº¦ï¼ˆæ›´æ…¢ï¼Œæ¸¸åŠ¨æ„Ÿï¼‰
          colors: [
            "rgba(0, 113, 227, 0.45)", // ä¸»è“è‰²
            "rgba(100, 160, 230, 0.35)", // æµ…è“
            "rgba(150, 180, 240, 0.3)", // æ›´æµ…è“
            "rgba(80, 130, 200, 0.4)", // ä¸­è“
          ],
        };

        // æ ¹æ®å±å¹•å¤§å°è®¡ç®—ç²’å­æ•°é‡
        function getParticleCount() {
          const area = canvas.width * canvas.height;
          const baseArea = 1920 * 1080;
          let count = Math.floor(config.baseCount * (area / baseArea));
          return Math.max(config.minCount, Math.min(config.maxCount, count));
        }

        function resize() {
          canvas.width = canvas.offsetWidth;
          canvas.height = canvas.offsetHeight;
        }

        function createParticle() {
          const x = Math.random() * canvas.width;
          const y = Math.random() * canvas.height;
          return {
            x: x,
            y: y,
            homeX: x, // åŸå§‹ä½ç½®
            homeY: y,
            vx: 0,
            vy: 0,
            radius: config.baseRadius + Math.random() * 2,
            color:
              config.colors[Math.floor(Math.random() * config.colors.length)],
            floatOffset: Math.random() * Math.PI * 2, // æµ®åŠ¨ç›¸ä½åç§»
            floatSpeedX: 0.3 + Math.random() * 0.4, // ä¸ªä½“æµ®åŠ¨é€Ÿåº¦
            floatSpeedY: 0.2 + Math.random() * 0.3,
          };
        }

        function initParticlePositions() {
          particles = [];
          const count = getParticleCount();
          for (let i = 0; i < count; i++) {
            particles.push(createParticle());
          }
        }

        function animate() {
          time += 0.01;
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          particles.forEach((p) => {
            // è‡ªç„¶æµ®åŠ¨æ•ˆæœ
            const floatX =
              Math.sin(time * p.floatSpeedX + p.floatOffset) *
              config.floatAmplitude *
              0.3;
            const floatY =
              Math.cos(time * p.floatSpeedY + p.floatOffset) *
              config.floatAmplitude *
              0.2;

            // ç›®æ ‡ä½ç½® = åŸå§‹ä½ç½® + æµ®åŠ¨åç§»
            const targetX = p.homeX + floatX;
            const targetY = p.homeY + floatY;

            // é¼ æ ‡äº¤äº’ - æ¨å¼€æ•ˆæœ
            const dx = mouseX - p.x;
            const dy = mouseY - p.y;
            const dist = Math.sqrt(dx * dx + dy * dy);

            if (dist < config.mouseRadius && dist > 0) {
              const force = (config.mouseRadius - dist) / config.mouseRadius;
              p.vx -= (dx / dist) * force * config.mouseForce;
              p.vy -= (dy / dist) * force * config.mouseForce;
            } else {
              // è‡ªåŠ¨å¤ä½åˆ°æµ®åŠ¨ç›®æ ‡ä½ç½®
              p.vx += (targetX - p.x) * config.resetSpeed;
              p.vy += (targetY - p.y) * config.resetSpeed;
            }

            // åº”ç”¨é€Ÿåº¦
            p.x += p.vx;
            p.y += p.vy;

            // é€Ÿåº¦è¡°å‡
            p.vx *= 0.92;
            p.vy *= 0.92;

            // è¾¹ç•Œè½¯çº¦æŸ
            if (p.x < -50) p.x = canvas.width + 50;
            if (p.x > canvas.width + 50) p.x = -50;
            if (p.y < -50) p.y = canvas.height + 50;
            if (p.y > canvas.height + 50) p.y = -50;

            // ç»˜åˆ¶ç²’å­
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
            ctx.fillStyle = p.color;
            ctx.fill();
          });

          animationId = requestAnimationFrame(animate);
        }

        // é¼ æ ‡ç§»åŠ¨ç›‘å¬
        document
          .getElementById("main-content")
          .addEventListener("mousemove", (e) => {
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
          });

        // é¼ æ ‡ç¦»å¼€æ—¶é‡ç½®ä½ç½®
        document
          .getElementById("main-content")
          .addEventListener("mouseleave", () => {
            mouseX = -1000;
            mouseY = -1000;
          });

        // åˆå§‹åŒ–
        resize();
        initParticlePositions();
        animate();

        // çª—å£å¤§å°å˜åŒ–
        window.addEventListener("resize", () => {
          resize();
          initParticlePositions();
        });

        // æš´éœ²éšè—/æ˜¾ç¤ºæ–¹æ³•
        window.hideParticles = () => canvas.classList.add("hidden");
        window.showParticles = () => canvas.classList.remove("hidden");
      })();
    </script>

    <!-- è®¾ç½®å¼¹çª— -->
    <div
      class="settings-modal"
      id="settings-modal"
      onclick="if(event.target === this) closeSettings()"
    >
      <div class="settings-panel">
        <h3>âš™ï¸ Settings</h3>
        <div class="settings-group">
          <label>Input Folder (å›¾ç‰‡ä¿å­˜ä½ç½®)</label>
          <input type="text" id="input-folder" placeholder="/path/to/inputs" />
        </div>
        <div class="settings-group">
          <label>Output Folder (æ¨¡å‹è¾“å‡ºä½ç½®)</label>
          <input
            type="text"
            id="output-folder"
            placeholder="/path/to/outputs"
          />
        </div>
        <p style="font-size: 11px; color: #888; margin: 12px 0 0 0">
          âš ï¸ ä¿®æ”¹åéœ€é‡å¯æœåŠ¡å™¨ç”Ÿæ•ˆ
        </p>
        <div class="settings-actions">
          <button class="btn-cancel" onclick="closeSettings()">Cancel</button>
          <button class="btn-save" onclick="saveSettings()">Save</button>
        </div>
      </div>
    </div>

    <script>
      // æŸ¥çœ‹åŸå›¾
      window.previewImage = function (url) {
        window.open(url, "_blank");
      };

      // æ£€æŸ¥æœ¬æœºè®¿é—®
      async function checkLocalAccess() {
        try {
          const res = await fetch("/api/settings");
          const data = await res.json();
          if (data.is_local) {
            document.getElementById("btn-settings").style.display = "flex";
          }
        } catch (e) {
          console.log("Settings check failed:", e);
        }
      }

      // æ‰“å¼€è®¾ç½®å¼¹çª—
      window.openSettings = async function () {
        const modal = document.getElementById("settings-modal");
        modal.style.display = "flex";
        requestAnimationFrame(() => modal.classList.add("visible"));

        // åŠ è½½å½“å‰è®¾ç½®
        try {
          const res = await fetch("/api/settings");
          const data = await res.json();
          if (data.input_folder) {
            document.getElementById("input-folder").value = data.input_folder;
          }
          if (data.output_folder) {
            document.getElementById("output-folder").value = data.output_folder;
          }
        } catch (e) {
          console.error("Failed to load settings:", e);
        }
      };

      // å…³é—­è®¾ç½®å¼¹çª—
      window.closeSettings = function () {
        const modal = document.getElementById("settings-modal");
        modal.classList.remove("visible");
        setTimeout(() => (modal.style.display = "none"), 300);
      };

      // ä¿å­˜è®¾ç½®
      window.saveSettings = async function () {
        const inputFolder = document.getElementById("input-folder").value;
        const outputFolder = document.getElementById("output-folder").value;

        try {
          const res = await fetch("/api/settings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              input_folder: inputFolder,
              output_folder: outputFolder,
            }),
          });
          const data = await res.json();
          if (data.success) {
            alert(data.message);
            closeSettings();
          } else {
            alert("Error: " + data.error);
          }
        } catch (e) {
          alert("Failed to save settings: " + e.message);
        }
      };

      // =====================================================
      // ğŸ¯ æ‹–æ‹½æ¨¡å‹æ–‡ä»¶åˆ°é¢„è§ˆåŒºåŸŸç›´æ¥åŠ è½½
      // æ”¯æŒ .ply å’Œ .splat æ ¼å¼
      // =====================================================
      (function setupModelDropZone() {
        const dropZone = document.getElementById("viewer-main");
        if (!dropZone) return;

        // åˆ›å»ºæ‹–æ‹½æç¤ºè¦†ç›–å±‚
        const dropOverlay = document.createElement("div");
        dropOverlay.id = "model-drop-overlay";
        dropOverlay.innerHTML = `
          <div class="drop-content">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="64" height="64">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <div>Drop .ply or .splat file to preview</div>
          </div>
        `;
        dropOverlay.style.cssText = `
          position: absolute;
          top: 0; left: 0; right: 0; bottom: 0;
          background: rgba(0, 122, 255, 0.15);
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
          border: 3px dashed rgba(0, 122, 255, 0.5);
          border-radius: 16px;
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 100;
          pointer-events: none;
        `;
        const dropContent = dropOverlay.querySelector(".drop-content");
        if (dropContent) {
          dropContent.style.cssText = `
            text-align: center;
            color: #007aff;
            font-weight: 500;
            font-size: 16px;
          `;
        }
        dropZone.appendChild(dropOverlay);

        let dragCounter = 0;

        dropZone.addEventListener("dragenter", (e) => {
          e.preventDefault();
          e.stopPropagation();
          dragCounter++;
          // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æ¨¡å‹æ–‡ä»¶
          const items = e.dataTransfer?.items;
          if (items) {
            for (let item of items) {
              if (item.kind === "file") {
                const name = item.type || "";
                // æ˜¾ç¤ºæ‹–æ‹½è¦†ç›–å±‚
                dropOverlay.style.display = "flex";
                break;
              }
            }
          }
        });

        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.stopPropagation();
        });

        dropZone.addEventListener("dragleave", (e) => {
          e.preventDefault();
          e.stopPropagation();
          dragCounter--;
          if (dragCounter === 0) {
            dropOverlay.style.display = "none";
          }
        });

        dropZone.addEventListener("drop", async (e) => {
          e.preventDefault();
          e.stopPropagation();
          dragCounter = 0;
          dropOverlay.style.display = "none";

          const files = e.dataTransfer?.files;
          if (!files || files.length === 0) return;

          // åªå¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶
          const file = files[0];
          const name = file.name.toLowerCase();

          // æ£€æŸ¥æ–‡ä»¶æ ¼å¼
          if (!name.endsWith(".ply") && !name.endsWith(".splat")) {
            alert("Unsupported format. Please drop .ply or .splat files.");
            return;
          }

          console.log("ğŸ“¦ Loading dropped model:", file.name);

          // åˆ›å»º Blob URL å¹¶åŠ è½½
          const blobUrl = URL.createObjectURL(file);
          try {
            await loadModel(blobUrl);
            // æ›´æ–°å½“å‰æ¨¡å‹åç§°æ˜¾ç¤º (å¦‚æœæœ‰)
            console.log("âœ… Model loaded:", file.name);
          } catch (err) {
            console.error("âŒ Failed to load model:", err);
            alert("Failed to load model: " + err.message);
            URL.revokeObjectURL(blobUrl);
          }
        });
      })();
    </script>
  </body>
</html>
